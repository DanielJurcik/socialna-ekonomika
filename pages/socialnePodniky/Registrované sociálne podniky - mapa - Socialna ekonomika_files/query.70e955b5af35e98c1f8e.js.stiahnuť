"use strict";(self.webpackChunkawesome_table_build=self.webpackChunkawesome_table_build||[]).push([[658],{18518:function(e,t,n){n(82526),n(41817),n(72443),n(92401),n(8722),n(32165),n(69007),n(83510),n(41840),n(6982),n(32159),n(96649),n(39341),n(60543),n(92222),n(50545),n(26541),n(43290),n(57327),n(69826),n(34553),n(84944),n(86535),n(89554),n(91038),n(26699),n(82772),n(66992),n(69600),n(94986),n(21249),n(26572),n(85827),n(96644),n(65069),n(47042),n(5212),n(2707),n(38706),n(40561),n(33792),n(99244),n(18264),n(39575),n(96078),n(4855),n(68309),n(73706),n(51532),n(99752),n(82376),n(73181),n(23484),n(2388),n(88621),n(60403),n(84755),n(25438),n(90332),n(40658),n(40197),n(44914),n(52420),n(60160),n(60970),n(10408),n(73689),n(9653),n(93299),n(35192),n(33161),n(44048),n(78285),n(44363),n(55994),n(61874),n(9494),n(56977),n(19601),n(59595),n(35500),n(69720),n(43371),n(38559),n(38880),n(49337),n(36210),n(30489),n(43304),n(41825),n(98410),n(72200),n(47941),n(94869),n(33952),n(57227),n(60514),n(41539),n(26833),n(88674),n(17727),n(36535),n(12419),n(69596),n(52586),n(74819),n(95683),n(39361),n(51037),n(5898),n(67556),n(14361),n(83593),n(39532),n(24603),n(74916),n(92087),n(39714),n(70189),n(79841),n(27852),n(94953),n(32023),n(78783),n(4723),n(66528),n(83112),n(38992),n(82481),n(15306),n(64765),n(23123),n(23157),n(73210),n(48702),n(55674),n(15218),n(74475),n(57929),n(50915),n(29253),n(42125),n(78830),n(58734),n(29254),n(37268),n(7397),n(60086),n(80623),n(44197),n(76495),n(87145),n(35109),n(65125),n(82472),n(49743),n(8255),n(29135),n(92990),n(18927),n(33105),n(35035),n(74345),n(7174),n(32846),n(98145),n(44731),n(77209),n(96319),n(58867),n(37789),n(33739),n(95206),n(29368),n(14483),n(12056),n(3462),n(30678),n(27462),n(33824),n(55021),n(12974),n(15016),n(4129),n(38478),n(54747),n(33948),n(84633),n(85844),n(60285),n(83753),n(41637),n(7039),n(87304),n(79023);var r=n(47376),a=n.n(r),o=n(17764),i=n(50473);function s(e){return Array.prototype.slice.call(e)}function u(e){return new Promise((function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}}))}function c(e,t,n){var r,a=new Promise((function(a,o){u(r=e[t].apply(e,n)).then(a,o)}));return a.request=r,a}function l(e,t,n){var r=c(e,t,n);return r.then((function(e){if(e)return new g(e,r.request)}))}function h(e,t,n){n.forEach((function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]}})}))}function f(e,t,n,r){r.forEach((function(r){r in n.prototype&&(e.prototype[r]=function(){return c(this[t],r,arguments)})}))}function d(e,t,n,r){r.forEach((function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})}))}function _(e,t,n,r){r.forEach((function(r){r in n.prototype&&(e.prototype[r]=function(){return l(this[t],r,arguments)})}))}function p(e){this.p_index=e}function g(e,t){this.p_cursor=e,this._request=t}function m(e){this.p_store=e}function y(e){this.p_tx=e,this.complete=new Promise((function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)}}))}function v(e,t,n){this.p_db=e,this.oldVersion=t,this.transaction=new y(n)}function b(e){this.p_db=e}h(p,"p_index",["name","keyPath","multiEntry","unique"]),f(p,"p_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),_(p,"p_index",IDBIndex,["openCursor","openKeyCursor"]),h(g,"p_cursor",["direction","key","primaryKey","value"]),f(g,"p_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach((function(e){e in IDBCursor.prototype&&(g.prototype[e]=function(){var t=this,n=arguments;return Promise.resolve().then((function(){return t.p_cursor[e].apply(t.p_cursor,n),u(t._request).then((function(e){if(e)return new g(e,t._request)}))}))})})),m.prototype.createIndex=function(){return new p(this.p_store.createIndex.apply(this.p_store,arguments))},m.prototype.index=function(){return new p(this.p_store.index.apply(this.p_store,arguments))},h(m,"p_store",["name","keyPath","indexNames","autoIncrement"]),f(m,"p_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getAllKeys","count"]),_(m,"p_store",IDBObjectStore,["openCursor","openKeyCursor"]),d(m,"p_store",IDBObjectStore,["deleteIndex"]),y.prototype.objectStore=function(){return new m(this.p_tx.objectStore.apply(this.p_tx,arguments))},h(y,"p_tx",["objectStoreNames","mode"]),d(y,"p_tx",IDBTransaction,["abort"]),v.prototype.createObjectStore=function(){return new m(this.p_db.createObjectStore.apply(this.p_db,arguments))},h(v,"p_db",["name","version","objectStoreNames"]),d(v,"p_db",IDBDatabase,["deleteObjectStore","close"]),b.prototype.transaction=function(){return new y(this.p_db.transaction.apply(this.p_db,arguments))},h(b,"p_db",["name","version","objectStoreNames"]),d(b,"p_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach((function(e){[m,p].forEach((function(t){t.prototype[e.replace("open","iterate")]=function(){var t=s(arguments),n=t[t.length-1],r=this.p_store||this.p_index,a=r[e].apply(r,t.slice(0,-1));a.onsuccess=function(){n(a.result)}}}))})),[p,m].forEach((function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise((function(a){n.iterateCursor(e,(function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():a(r)):a(r)}))}))})}));var A=function(e,t,n){var r=c(indexedDB,"open",[e,t]),a=r.request;return a.onupgradeneeded=function(e){n&&n(new v(a.result,e.oldVersion,a.transaction))},r.then((function(e){return new b(e)}))};function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function S(e,t,n){return t&&T(e.prototype,t),n&&T(e,n),e}var O=function(){function e(t,n){E(this,e),this.dbName=t,this.storeName=n,this.oldCacheTimeOut=i.k}return S(e,[{key:"openIdb",value:function(){var e=this;return Promise.resolve().then((function(){return A(e.dbName,1,(function(t){t.createObjectStore(e.storeName)}))}))}},{key:"getValue",value:function(e){var t=this;return this.openIdb().then((function(n){return n.transaction(t.storeName,"readonly").objectStore(t.storeName).get(e)}))}},{key:"setValue",value:function(e,t){var n=this;return this.openIdb().then((function(r){var a=r.transaction(n.storeName,"readwrite"),o=a.objectStore(n.storeName);return at_debug.log("CACHE","Storing new data for key "+e),o.put(t,e),o.put((new Date).getTime(),"ts__"+e),a.complete}))}},{key:"clearCache",value:function(e){var t=this;return this.openIdb().then((function(n){var r=n.transaction(t.storeName,"readwrite"),a=r.objectStore(t.storeName);return at_debug.log("CACHE","clearing cache for key "+e),a.delete(e),a.delete("ts__"+e),r.complete}))}},{key:"clearOldCache",value:function(){var e=this;return this.openIdb().then((function(t){var n=t.transaction(e.storeName,"readwrite"),r=n.objectStore(e.storeName);return r.openCursor().then((function t(n){if(n)return/^ts__/.test(n.key)&&(new Date).getTime()-n.value>e.oldCacheTimeOut&&(at_debug.log("CACHE","clearing cache for key "+n.key),r.delete(n.key),r.delete(n.key.substring(4,n.key.length))),n.continue().then(t)})),n.complete}))}}]),e}(),D=function(){function e(t,n,r){E(this,e),this.dbName=void 0,this.dbStore=void 0,this.key=void 0,this.persistedData=void 0,this._idb=void 0,this._oldDataCleared=!1,this._dataUpdateCallback=function(){},this.clearCacheForKey=this.clearCacheForKey.bind(this),t&&n&&this.setDbStore(t,n,r)}return S(e,[{key:"_setPersistedDate",value:function(e){var t=this.persistedData;this.persistedData=e,t!==e&&this._dataUpdateCallback(e,t)}},{key:"setDbStore",value:function(e,t,n){e&&t&&(e!==this.dbName||t!==this.dbStore)&&(this.dbName=e,this.dbStore=t,n&&this.setDataCallback(n),void 0!==this.persistedData&&(this.persistedData=void 0),this._idb=new O(e,t),this.key&&this.setKey(this.key))}},{key:"setDataCallback",value:function(e){this._dataUpdateCallback=e}},{key:"setKey",value:function(e){var t=this;at_debug.log("CACHE","Attempting to load cache for key "+e),this.key=e,this.key&&void 0===this.persistedData?this._idb.getValue(e).then((function(n){void 0!==n?(at_debug.log("CACHE","found cached data for key "+e),t._setPersistedDate(n)):at_debug.log("CACHE","no cached data for key "+e)})):at_debug.log("CACHE","key is undefined or data already persisted, not cycling through cache")}},{key:"setData",value:function(e){var t=this;console.log("SET data",e,this),this.key&&void 0!==e&&(this._setPersistedDate(e),this._idb.setValue(this.key,e).then((function(){t._oldDataCleared||(t._oldDataCleared=!0,setTimeout((function(){return t._idb.clearOldCache()}),5e3))})))}},{key:"clearCacheForKey",value:function(e){this._idb&&this._idb.clearCache(e)}}]),e}(),R=n(27638),I=n(35770),w=n(48668);function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var N=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),C(this,"_eventLogged",!1),C(this,"_dataFetched",!1)}var t,n,r;return t=e,(n=[{key:"setInfo",value:function(e){this._provider=e.provider,this._referrer=e.referrer,this._appId=e.appId,this._appTier=e.appTier,this._vizType=e.vizType,this._allowMapsOverusage=e.allowMapsOverusage}},{key:"setReferer",value:function(e){this._initialReferrer=e}},{key:"setDataFetched",value:function(){this._dataFetched=!0,this._logAppView()}},{key:"setUser",value:function(e){this._userEmail=e.email,this._userId=e.id||"",this._logAppView()}},{key:"_logAppView",value:function(){var e=this;if(this._userEmail&&!this._eventLogged&&this._dataFetched){try{if(I.Z.inPreview(window.top.location.href)||I.Z.inPreview(I.Z.referrer))return void at_debug.log("We are in preview|edit|settings|print, not dispatching app_display event")}catch(e){at_debug.log("Caught error while verifying origin ",e)}at_debug.log({message:"SEND VIEW EVENT",data:{email:this._userEmail,id:this._userId,appId:this._appId,referrer:this._referrer,app_tier:this._appTier,viz_type:this._vizType,allow_maps_over_usage:this._allowMapsOverusage}}),window.fetch("https://us-central1-awesome-table-server.cloudfunctions.net/loggerService",{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({event_type:"app_display",event_time:(new Date).getTime(),app_id:this._appId,referrer:this._initialReferrer||this._referrer,user_email:this._userEmail,user_id:this._userId,app_tier:this._appTier,viz_type:this._vizType,allow_maps_over_usage:this._allowMapsOverusage})}).then((function(t){e._eventLogged=!0})).catch((function(e){console.error(e)}))}}}])&&k(t.prototype,n),r&&k(t,r),e}(),P=n(62),U=n(57370),L=n(42845),M=n(82303),j=n(64363),x=n(72382),H=new R.Z("UA-17877121-8","confStats");H.setCustomD({dimension11:"4.98.0"});var F,B=H;function q(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var G=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._oldUser={},this.logger=t,this.user=void 0,this.uid=void 0,this.login=this.login.bind(this),this.logout=this.logout.bind(this),this._googleLogin=this._googleLogin.bind(this),this._errorHandler=this._errorHandler.bind(this),this._onIdTokenChanged=this._onIdTokenChanged.bind(this),this.googleLogin=this.googleLogin.bind(this),this.app=o.l2,this.ref=o.iH,this._googleAuthHelper=new j.N,o.l2.auth().onIdTokenChanged(this._onIdTokenChanged,this._errorHandler)}var t,n,r;return t=e,(n=[{key:"_refError",get:function(){return!F&&(F=this.app.database("https://".concat("awesome-table","-errors.firebaseio.com")).ref()),F}},{key:"_errorHandler",value:function(e,t){var n=e.detail||e;if(at_debug.error(JSON.stringify(n,null,"\t")),B.sendStats({category:"error",action:n.code}),"auth/account-exists-with-different-credential"===e.code&&t)return this._fixFirebaseLogin(t).then((function(){return B.sendStats({category:"error",action:"success/fix-account-exists-with-different-credential"})}))}},{key:"_fixFirebaseLogin",value:function(e){var t=this;return(0,x.he)("https://api.awesome-table.com",{fireDomain:"awesome-table",token:e,action:"register",getToken:!0,providerId:U.xY[U.Bl.GOOGLE]}).then((function(e){return t.app.auth().signInWithCustomToken(e)})).then((function(t){var n=firebase.auth.GoogleAuthProvider.credential(null,e);return t.user.linkWithCredential(n)}))}},{key:"_onIdTokenChanged",value:function(e){var t=this;if(e!==this._oldUser){if(this._oldUser=e,!e)return at_debug.log("LOGOUT"),this.user=void 0,this.uid=void 0,void this.logger.setUser({email:"anonymous"});at_debug.log("LOGIN: start"),delete e.providerData[0].gid,e.providerData[0].gid=e.providerData[0].uid,this.user=e.providerData[0],this.uid=e.uid,B.setUserId(this.uid),B.setCustomD({dimension1:this.user.email&&this.user.email.split("@")[1],dimension2:this.uid}),this.logger.setUser({email:this.user.email,id:this.uid}),e.getIdToken(!0).then((function(e){var n=t.user;if(!n||!n.providerId)throw"User does not have any provider Id";var r=n&&n.providerId;return(0,x.he)("https://api.awesome-table.com",{fireIdToken:e,action:"register",fireDomain:"awesome-table",providerId:r})})).then((function(){at_debug.log("LOGIN: REGISTER success")})).catch((function(e){at_debug.error("LOGIN: REGISTER",e)}))}}},{key:"login",value:function(e){var t=this;return e&&"string"==typeof e?(at_debug.log("START LOGIN"),this.app.auth().signInWithCredential(firebase.auth.GoogleAuthProvider.credential(null,e)).catch((function(n){return t._errorHandler(n,e)})).then((function(){return t.app.auth().currentUser}))):Promise.resolve(null)}},{key:"logout",value:function(){return at_debug.log("LOGOUT"),this.app.auth().signOut()}},{key:"_googleLogin",value:function(e){return(0,M.x4)(e,"56088344336-mes14nget7f5jb0pfmi0scngbb82l0qa.apps.googleusercontent.com",L.Zz).then((function(e){if(!e.access_token)throw e;return e}))}},{key:"googleLogin",value:function(e){var t=this;try{return e?function(e){var n="boolean"!=typeof e.immediate||e.immediate;return e.immediate&&delete e.immediate,at_debug.log("Hello js login"),t._googleAuthHelper.login(e,n)}:function(e){return at_debug.log("Use Google auth"),t._googleLogin(e)}}catch(e){console.log(e)}}}])&&q(t.prototype,n),r&&q(t,r),e}(),V=n(74568),Y=n(72703),K=n(10139);function W(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e,t,n){return t&&W(e.prototype,t),n&&W(e,n),e}var J=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._accessToken=t,this._domain=n,this._securityCode=r}return Z(e,null,[{key:"API_ENDPOINT",get:function(){return"https://ao-docs.appspot.com/_ah/api/"}}]),Z(e,[{key:"_callAPI",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET";return n.headers=n.headers||{},this._accessToken&&(n.headers.Authorization="Bearer ".concat(this._accessToken)),this._securityCode&&(n.securityCode=this._securityCode),this._domain&&(n.domain=this._domain),(0,x.he)(e.API_ENDPOINT+t,n,r).catch((function(e){return e}))}},{key:"listLibraries",value:function(t){return t?this._callAPI("library/v1/plain",{},"PUT"):Promise.reject(new Error(e.ERRORS.NO_DOMAIN))}},{key:"listViews",value:function(t){return t?this._callAPI("view/v1/libraries/".concat(t)):Promise.reject(new Error(e.ERRORS.NO_LIBRARY_ID))}},{key:"probeLibraryAccess",value:function(t){if(!t)return Promise.reject(new Error(e.ERRORS.NO_LIBRARY_ID));var n="library/v1/".concat(t),r={include:"NONE",fields:encodeURIComponent("libraryId,name")};return this._callAPI(n,r).then((function(e){if(e.name&&e.libraryId)return{name:e.name,id:e.libraryId};throw"malformed library response"})).catch((function(){return{error:{status:"PERMISSION_DENIED"}}}))}},{key:"loadDocumentClass",value:function(t,n){if(!t)return Promise.reject(new Error(e.ERRORS.NO_LIBRARY_ID));if(!n)return Promise.reject(new Error(e.ERRORS.NO_DOCUMENT_CLASS_ID));var r="documentType/v1/libraries/".concat(t,"/documentTypes/").concat(n),a={fields:encodeURIComponent("displayName,fields(displayName,id,type),id")};return this._callAPI(r,a).then((function(e){return{displayName:e.displayName,id:e.id,fields:e.fields?e.fields.map((function(e){return{displayName:e.displayName,id:e.id,type:e.type}})):[]}}))}},{key:"loadDocumentClasses",value:function(t,n){var r=this;return t?n?Array.isArray(n)?Promise.all(n.map((function(e){return r.loadDocumentClass(t,e)}))):Promise.reject(new Error(e.ERRORS.NOT_ARRAY_DOCUMENT_CLASSES)):Promise.reject(new Error(e.ERRORS.NO_DOCUMENT_CLASS_ID)):Promise.reject(new Error(e.ERRORS.NO_LIBRARY_ID))}},{key:"loadDocument",value:function(t){if(!t)return Promise.reject(new Error(e.ERRORS.NO_DOCUMENT_ID));var n="document/v1/".concat(t),r={fields:encodeURIComponent("attachments(fileId,mimeType),categories(fieldName,multiple,values),className,fields(fieldName,multiple,type,values),id,systemFields(displayName,value),title")};return this._callAPI(n,r).then((function(e){return{title:e.title,className:e.className,id:e.id,attachments:e.attachments?e.attachments.map((function(e){return{fileId:e.fileId,mimeType:e.mimeType}})):[],categories:e.categories?e.categories.map((function(e){return{fieldName:e.fieldName,multiple:e.multiple,type:e.type,values:e.values}})):[],fields:e.fields?e.fields.map((function(e){return{fieldName:e.fieldName,multiple:e.multiple,type:e.type,values:e.values}})):[],systemFields:e.systemFields?e.systemFields.map((function(e){return{displayName:e.displayName,value:e.value}})):[]}}))}},{key:"loadDocuments",value:function(t){var n=this;return t?Promise.all(t.map((function(e){return n.loadDocument(e)}))):Promise.reject(new Error(e.ERRORS.NO_DOCUMENT_ID))}},{key:"countDocuments",value:function(t,n){return t?n?this._callAPI("search/v1/libraries/".concat(t,"/count"),{classId:n},"POST").then((function(e){return e.count})):Promise.reject(new Error(e.ERRORS.NO_DOCUMENT_CLASS_ID)):Promise.reject(new Error(e.ERRORS.NO_LIBRARY_ID))}},{key:"getDocumentsByView",value:function(e,t){var n=this,r="search/v1/libraries/".concat(e,"/views/").concat(t),a=100,o=encodeURIComponent("count,documents(attachments(fileId,mimeType),categories(fieldName,multiple,values),className,fields(fieldName,multiple,type,values),id,systemFields(displayName,value),title),precision");return this._callAPI(r,{offset:0,limit:a},"POST").then((function(e){var t=e.count,i=[],s=t-e.documents.length;if(i=i.concat(e.documents),s<=0)return i;for(var u=Math.ceil(s/a),c=[],l=0;l<u;l++)c.push({limit:a,offset:(l+1)*a,fields:o});for(var h=0,f=function(e){return n._callAPI(r,e,"POST").then((function(e){return{precision:e.precision,count:e.count,documents:e.documents.map((function(e){return{title:e.title,className:e.className,id:e.id,numberOfAttachments:e.numberOfAttachments,checkOutDate:e.checkOutDate,checkOutBy:e.checkOutBy,modificationDate:e.modificationDate,updateAuthor:e.updateAuthor,creationDate:e.creationDate,initialAuthor:e.initialAuthor,fullSizeOfAttachments:e.fullSizeOfAttachments,state:e.state,stateChangeDate:e.stateChangeDate,versionName:e.versionName,folders:e.folders?e.folders.map((function(e){return{name:e.name}})):[],stateChangeAuthors:e.stateChangeAuthors?e.stateChangeAuthors.map((function(e){return{displayName:e.displayName}})):[],attachments:e.attachments?e.attachments.map((function(e){return{fileId:e.fileId,mimeType:e.mimeType}})):[],categories:e.categories?e.categories.map((function(e){return{fieldName:e.fieldName,multiple:e.multiple,type:e.type,values:e.values}})):[],fields:e.fields?e.fields.map((function(e){return{fieldName:e.fieldName,multiple:e.multiple,type:e.type,values:e.values}})):[],systemFields:e.systemFields?e.systemFields.map((function(e){return{displayName:e.displayName,value:e.value}})):[]}}))}}))},d=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:250,a=void 0===n?h++:n;if(a>=u)return t;var o=c[a];return f({limit:o.limit,offset:o.offset}).then((function(e){if(!e.documents)throw"retry";return t=t.concat(e.documents),{}})).catch((function(){return new Promise((function(e){return setTimeout(e,r)})).then((function(){return o.failure=(o.failure||0)+1,o.failure>=3?{}:{retryIndex:a,delay:2*r}}))})).then((function(n){var r=n.retryIndex,a=n.delay;return void 0!==r?e(t,r,a):e(t)}))},_=[],p=0;p<5;p++)_.push(d());return Promise.all(_).then((function(e){return e})).then((function(e){return i.concat(e.flat())}))}))}},{key:"getDocsFromViews",value:function(t,n){var r=this;if(!Array.isArray(n))return Promise.reject(new Error(e.ERRORS.NO_LIST_OF_VIEW_DOC_CLASS));var a=Promise.resolve(),o=[];return n.map((function(e){a=a.then((function(){return r.getDocumentsByView(t,e)})).then((function(e){return o.push(e)}))})),a.then((function(){return o.flat()}))}}]),e}();J.ERRORS={NO_DOCUMENT_ID:"Document ID must not be empty",NO_DOMAIN:"Domain must not be empty!",NO_LIBRARY_ID:"Library ID must not be empty!",NO_DOCUMENT_CLASS_ID:"Document Class ID must not be empty!",NO_DOCUMENT_CLASSES:"Document Classes must not be empty!",NO_VIEW_ID:"Document Class ID must not be empty!",NO_LIST_OF_VIEW_DOC_CLASS:"Not a list of pair of viewId and docClass",NOT_ARRAY_DOCUMENT_CLASSES:"Document Class IDs must be an array!"};var z=J,Q=n(36494),X=n(7749);function $(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return ee(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ee(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var te=function(e){var t=$(e.match(/(^[A-Z]+)|([0-9]+$)/gm)||[],2),n=t[0],r=t[1];if(void 0===n&&void 0===r)throw"Invalid cell reference";var a={row:null,col:null};return void 0!==r&&(a.row=function(e){return+e-1}(r)),void 0!==n&&(a.col=function(e){if("string"!=typeof e)throw"Expected column label";for(var t=0,n=(e=e.toUpperCase()).length-1,r=0;n>-1;n--,r++)t+=(e.charCodeAt(n)-64)*Math.pow(26,r);return t}(n)),a},ne=function(e){try{var t=$(e.split(":"),2),n=t[0],r=t[1],a=te(n),o=r&&te(r)||a;return{start:a,end:o,width:null!==a.col&&null!==o.col?o.col-a.col+1:null,height:null!==a.row&&null!==o.row?o.row-a.row+1:null}}catch(e){throw"Invalid range reference"}},re=n(43650);function ae(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oe(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ie,se=function(){var e=Object.keys(re).map((function(e){return re[e].regex||re[e]}));return new RegExp("^\\s+|\\s+$|(?:(?:\\s*-\\s*|\\s)((".concat(e.join("|"),")(?:\\s?\\(([^)]+)\\))?)(?:\\s*-\\s*(?!\\w)|\\s(?!\\w))?)"),"ig")},ue=function(e){for(var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=se(),a=(n?"":"- ")+e,o=[];null!==(t=r.exec(a));)if(t[1]){var i=t,s=ae(i,4),u=s[2],c=s[3];o.push({keyword:u.toLowerCase(),params:c?c.split(/\s*,\s*/):null})}return o},ce=function(e,t,n){var r,a=function(e){var t={};return e.cols.forEach((function(e){t[e.label.replace(se(),"")]=ue(e.label,!0)})),t}(e.data),o=se();if(e.data.cols.forEach((function(e){e.label=e.label.replace(o,"")})),t.data){var i=function(e,t){var n,r,a,o,i,s=ne(t),u=null;return(n=1===s.height||1===e.rows.length?{templates:[{label:X.YM,template:""+e.rows[0].c[0].v}],onlyDisplay:(a={},o=X.YM,i=!0,o in a?Object.defineProperty(a,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):a[o]=i,a),noAutoAdd:!1}:3===s.height&&3===e.rows.length?{templates:(r=[],u={},e.cols.forEach((function(t,n){if(e.rows[2].c[n]&&null!==e.rows[2].c[n].v&&""!==e.rows[2].c[n].v){var a=""+(e.rows[0].c[n]&&e.rows[0].c[n].v||X.rd).trim();r.push({label:a,template:""+(e.rows[2].c[n].v||"")}),u[a]=ue(""+(e.rows[1].c[n]&&e.rows[1].c[n].v||""))}})),r),noAutoAdd:!1}:{templates:function(){var t=[];return e.rows.length>0&&e.cols.forEach((function(n,r){e.rows[1].c[r]&&null!==e.rows[1].c[r].v&&""!==e.rows[1].c[r].v&&t.push({label:""+(e.rows[0].c[r]&&e.rows[0].c[r].v||X.rd).trim(),template:""+(e.rows[1].c[r].v||"")})})),t}(),noAutoAdd:3!==s.height}).signature=Y.Z.SHA256(JSON.stringify(n)).toString(),{templateColumnsSettings:u,templates:n}}(t.data,n),s=i.templateColumnsSettings;r=i.templates,s&&Object.keys(s).forEach((function(e){a[e]?s[e].forEach((function(t){var n=a[e].find((function(e){return e.keyword===t.keyword}));n?n.params=t.params:a[e].push(t)})):a[e]=s[e]}))}return new K.n({data:{dataTable:e.data,signature:e.sig||Y.Z.SHA256(JSON.stringify(e.data)).toString()},settings:{columns:a,signature:Y.Z.SHA256(JSON.stringify(a)).toString()},template:r||null})};function le(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return he(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return he(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function he(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function fe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function de(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _e=(de(ie={},X.BI,!0),de(ie,X.xG,!0),de(ie,X.rd,!0),de(ie,X.YM,!0),ie),pe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=V.tW.AODOCS,this.tools=t,this.isAuth=!1,this._accessToken="",this._source=void 0,this._dateFormat="yyyy/mm/dd"}var t,n,r;return t=e,r=[{key:"_findWithProperty",value:function(t,n,r){if(!Array.isArray(t))throw new Error(e.ERRORS.FIELD_LIST_NOT_ARRAY);return t.map((function(e){return e[n]})).indexOf(r)}},{key:"_createDefaultArray",value:function(e,t){if(!Number.isInteger(t))throw new Error("Size must be an integer!");return new Array(t).fill(e,0,t)}},{key:"_convertType",value:function(t){switch(t.toLowerCase()){case e.AODOCS_TYPES.DECIMAL:case e.AODOCS_TYPES.INTEGER:return e.AT_TYPES.NUMBER;case e.AODOCS_TYPES.DATE:return e.AT_TYPES.DATE;case e.AODOCS_TYPES.TIME:return e.AT_TYPES.DATE_TIME;default:return e.AT_TYPES.STRING}}}],(n=[{key:"_auth",value:function(){var e=this;if(at_debug.log("FETCH_DATA","start AUTH"),this.ready=new Promise((function(t,n){e._authDone_res=t,e._authDone_rej=n})),this._accessToken)return this.isAuth=!0,void new z(this._accessToken).probeLibraryAccess(this._source.libraryId).then((function(){e._authDone_res()})).catch((function(){e._authDone_rej()}));this._loginAuthUser(0)}},{key:"_loginAuthUser",value:function(t){var n=this;if(t>=e.CONSTS.AUTH_USER_MAX_TENTATIVES)return at_debug.log("FETCH_DATA","auth FAILED, waiting for manual login"),this.tools.showManualLogin(),void this.tools.sendAuthAnalytics("max tentative");at_debug.log("FETCH_DATA","login with user ".concat(t)),this.tools.login({authUser:t}).then((function(e){return n._accessToken=e&&e.access_token||"",n.isAuth=!0,new z(n._accessToken,n._source.domain).probeLibraryAccess(n._source.libraryId).then((function(e){if(!e.error)return n._authDone_res();n._accessToken="",n.isAuth=!1,n._loginAuthUser(t+1)}))})).then((function(){n.tools.sendAuthAnalytics(t)})).catch((function(){n._accessToken="",n.isAuth=!1,n._loginAuthUser(t+1)}))}},{key:"_extractFieldNames",value:function(t){if(!t)throw new Error(e.ERRORS.EMPTY_AODOCS_LIST);if(!Array.isArray(t))throw new Error(e.ERRORS.DOCS_NOT_ARRAY);var n=[{label:"Title",type:"string"},{label:"Class Name",type:"string"},{label:"ID",type:"string"},{label:"Description",type:"string"},{label:"Attachment number",type:"string"},{label:"Checked out date",type:"string"},{label:"Checked out by",type:"string"},{label:"Last update",type:"string"},{label:"Last update author",type:"string"},{label:"Creation date",type:"string"},{label:"Document creator",type:"string"},{label:"Folder",type:"string"},{label:"Full size",type:"string"},{label:"State",type:"string"},{label:"State change date",type:"string"},{label:"State change authors",type:"string"},{label:"Version name",type:"string"}];return t.forEach((function(t){t.fields.forEach((function(t){-1===e._findWithProperty(n,"label",t.displayName)&&n.push({label:t.displayName,type:e._convertType(t.type)})}))})),n}},{key:"_buildDataTable",value:function(t,n){var r=this;if(!t)throw new Error(e.ERRORS.EMPTY_FIELDS);if(!n)throw new Error(e.ERRORS.EMPTY_AODOCS_LIST);if(!Array.isArray(n))throw new Error(e.ERRORS.DOCS_NOT_ARRAY);for(var a={cols:[],rows:[]},o=0;o<t.length;o++){var i={id:(0,x.zI)(o+1),label:t[o].label,type:t[o].type};i.type===e.AODOCS_TYPES.DATE&&(i.pattern=this._dateFormat),a.cols.push(i)}return n.forEach((function(n){if(n){var o={c:e._createDefaultArray({v:"",f:""},t.length)};o.c[e._findWithProperty(t,"label","Title")]={v:n.title},o.c[e._findWithProperty(t,"label","Class Name")]={v:n.className},o.c[e._findWithProperty(t,"label","ID")]={v:n.id},o.c[e._findWithProperty(t,"label","Attachment number")]={v:n.numberOfAttachments},o.c[e._findWithProperty(t,"label","Checked out at")]=n.checkOutDate?r._extractDateValue([n.checkOutDate],!1):"",o.c[e._findWithProperty(t,"label","Checked out by")]={v:n.checkOutBy},o.c[e._findWithProperty(t,"label","Last update")]=n.modificationDate?r._extractDateValue([n.modificationDate],!1):"",o.c[e._findWithProperty(t,"label","Last update author")]={v:n.updateAuthor},o.c[e._findWithProperty(t,"label","Creation date")]=n.creationDate?r._extractDateValue([n.creationDate],!1):"",o.c[e._findWithProperty(t,"label","Document creator")]={v:n.initialAuthor},o.c[e._findWithProperty(t,"label","Folder")]={v:n.folders&&n.folders.map((function(e){return e.name})).join("/")},o.c[e._findWithProperty(t,"label","Full size")]={v:n.fullSizeOfAttachments},o.c[e._findWithProperty(t,"label","State")]={v:n.state},o.c[e._findWithProperty(t,"label","State change date")]=n.stateChangeDate&&r._extractDateValue([n.stateChangeDate],!1),o.c[e._findWithProperty(t,"label","State change authors")]={v:n.stateChangeAuthors&&n.stateChangeAuthors.map((function(e){return e.displayName})).join(", ")},o.c[e._findWithProperty(t,"label","Version name")]={v:n.versionName},n.systemFields.forEach((function(n){n.value&&(o.c[e._findWithProperty(t,"label",n.displayName)]={v:n.value})})),n.fields.forEach((function(n){var a=n.fieldName,i=n.type,s=n.multiple,u=n.values;if(u){var c=e._convertType(i),l=e._findWithProperty(t,"label",a);switch(c){case e.AT_TYPES.DATE:o.c[l]=r._extractDateValue(u,s);break;case e.AT_TYPES.NUMBER:o.c[l]=r._extractNumberValue(u,s);break;default:o.c[l]={v:s?u.join("\n"):u[0]}}}})),n.categories&&n.categories.forEach((function(n){n.values&&(o.c[e._findWithProperty(t,"label",n.fieldName)]={v:r._extractAODocsCategoryValues(n.values).slice(0,-2)})})),a.rows.push(o)}})),a}},{key:"_loadTemplateSettings_fromAttachment",value:function(t){var n=this;return t?this._AODocsAPI.loadDocument(t).then((function(t){if(!t.attachments)throw e.ERRORS.NO_ATTACHMENT;var r=t.attachments.filter((function(t){return t.mimeType===e.CONSTS.SPREADSHEET_MIME_TYPE})),a=n._getAODocsFields(t,["Settings Sheet Name","Settings Sheet Range"]),o=a["Settings Sheet Name"],i=a["Settings Sheet Range"],s=o&&o.values?o.values[0]:void 0,u=i&&i.values?i.values[0]:void 0;return n._getTemplateSettingsFromSheet(r[0].fileId,s,u)})).then((function(e){return{templates:e.template,columnsSettings:e.settings}})):{templates:void 0,columnsSettings:void 0}}},{key:"_getTemplateSettingsFromSheet",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"1:3",a="https://sheets.googleapis.com/v4/spreadsheets/".concat(t,"?fields=sheets/properties/title,sheets/data&ranges=").concat(n,"!").concat(r,"&key=").concat("AIzaSyAPCgK_J99eBCsm0Ub6vnivt3_GVFcXqVM"),o={headers:{}};return this._accessToken&&(o.headers.Authorization="Bearer ".concat(this._accessToken)),(0,x.he)(a,o).then((function(t){if(!("sheets"in t&&Array.isArray(t.sheets)&&"data"in t.sheets[0]&&Array.isArray(t.sheets[0].data)&&Array.isArray(t.sheets[0].data)&&"rowData"in t.sheets[0].data[0]))throw new Error(e.ERRORS.MALFORMED_SHEET_RESPONSE);var n=t.sheets[0].data[0].rowData,r=(n[0].values||[]).map((function(e){return e.formattedValue})),a={};return(n[1].values||[]).forEach((function(e,t){_e[r[t]]||(a[r[t]]=ue(e.formattedValue))})),{template:(n[2].values||[]).map((function(e,t){return{label:r[t],template:e.formattedValue}})).filter((function(e){return void 0!==e.template})),settings:a}}))}},{key:"_extractNumberValue",value:function(e,t){var n=e.map((function(e){return+e}));return{v:t?n.join("\n"):n[0]}}},{key:"_extractDateValue",value:function(e,t){var n=this,r=[],a=[];return[].concat(e).forEach((function(e){var t=new Date(parseInt(e)),o=t.getDate(),i=t.getMonth(),s=t.getFullYear();r.push("Date(".concat(s,",").concat(i,",").concat(o,")")),a.push(n._dateFormat.replace(/d+/i,String(o)).replace(/m+/i,String(i)).replace(/y+/i,String(s)))})),{v:t?r.join("\n"):r[0],f:t?a.join("\n"):a[0]}}},{key:"_extractAODocsCategoryValues",value:function(e){var t=this;if(Array.isArray(e)){var n="";return e.forEach((function(e){n+=t._extractAODocsCategoryValues(e)})),n}return e.name?e.name+", ":""}},{key:"_getAODocsFields",value:function(e,t){t=[].concat(t);var n={};return e.fields.filter((function(e){return t.includes(e.fieldName)})).forEach((function(e){n[e.fieldName]=e})),n}},{key:"set",value:function(e){e.token&&(this._accessToken=e.token),this._source=new Q.u(e.sourceSettings),this._auth()}},{key:"getData",value:function(){var e=this;return this.ready.then((function(){console.time("AODOCS GET DATA");var t={},n=Object.keys(e._source.views).map((function(n){return t[e._source.views[n].docClass]=!0,n})),r=Object.keys(t);e._AODocsAPI=new z(e._accessToken,e._source.domain,e._source.securityCode);var a=[e._AODocsAPI.loadDocumentClasses(e._source.libraryId,r),e._AODocsAPI.getDocsFromViews(e._source.libraryId,n),e._loadTemplateSettings_fromAttachment(e._source.templateDocId)];return Promise.all(a).then((function(t){var n=le(t,3),r=n[0],a=n[1],o=n[2],i=o.templates,s=o.columnsSettings,u=e._extractFieldNames(r),c=e._buildDataTable(u,a),l=Y.Z.SHA256(JSON.stringify(c)).toString(),h=i&&Y.Z.SHA256(JSON.stringify(i)).toString(),f=s&&Y.Z.SHA256(JSON.stringify(s)).toString();return console.timeEnd("AODOCS GET DATA"),new K.n({data:{dataTable:c,signature:l},settings:{columns:s,signature:f},template:{templates:i,signature:h,onlyDisplay:void 0,noAutoAdd:!1}})})).catch((function(e){throw console.error(e),e}))}))}},{key:"getCacheKey",value:function(){return this._source.cacheKey}},{key:"buildCacheKey",value:function(e){return e.libraryId&&e.views?e.libraryId+Object.keys(e.views).join(""):JSON.stringify(e)}},{key:"onManualLogin",value:function(){var e=this;this.tools.login({authUser:-1,immediate:!1}).then((function(t){e._accessToken=t&&t.access_token||"",e.isAuth=!0,e.tools.loginDone(e.isAuth),e._authDone_res()})).catch((function(t){t.error&&"popup_closed_by_user"===t.error||(e._accessToken="",e.isAuth=!1,e.tools.loginDone(e.isAuth),e._authDone_rej())}))}}])&&fe(t.prototype,n),r&&fe(t,r),e}(),ge=pe;pe.CONSTS={AUTH_USER_MAX_TENTATIVES:6,SPREADSHEET_MIME_TYPE:"application/vnd.google-apps.spreadsheet"},pe.ERRORS={EMPTY_FIELDS:"Field object must not be empty!",EMPTY_AODOCS_LIST:"AODocs document list must not be empty!",DOCS_NOT_ARRAY:"AODocs document list must be an array!",FIELD_LIST_NOT_ARRAY:"Field list must be an array!",NO_ATTACHMENT:"There must be an attachment on the document!",MALFORMED_SHEET_RESPONSE:"The sheet data response is not in the expected format!"},pe.FIELD_KEYWORDS={DATE_FORMAT:"Date Format"},pe.AT_TYPES={STRING:"string",DATE:"date",DATE_TIME:"datetime",NUMBER:"number"},pe.AODOCS_TYPES={STRING:"string",TEXT:"text",DATE:"date",TIME:"time",DATE_TIME:"date & time",INTEGER:"integer",DECIMAL:"decimal",BOOLEAN:"boolean",PERSON:"person",GEOPOINT:"geopoint",URL:"url"};var me=n(5146),ye=n(91084),ve=n(81792);function be(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Ae(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ae(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ee(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=V.tW.EXCEL,this.tools=t,this._source=void 0,this._accessToken=null,this._userProfile=null,this._isManualLogin=!1,this._promptMode=null,this._ms=new me.Yy}var t,n,r;return t=e,r=[{key:"templateDefault",get:function(){return{noAutoAdd:!0,onlyDisplay:null,signature:null,templates:[]}}},{key:"isTemplateNotExists",value:function(e){if(!e.length)return!0;var t=e[0];return 1===t.length&&!t[0]}}],(n=[{key:"_auth",value:function(){var e=this;at_debug.log("FETCH_DATA","start MS AUTH"),this._ready=new Promise((function(t,n){e._authDone_res=t,e._authDone_rej=n})),this._ms.onLogin(this._loggedIn.bind(this));var t=this._ms.hasValidSession();if(this._accessToken||t)return at_debug.log("Using local session cache"),this.isAuth=!0,this._accessToken=t.access_token,void this._authDone_res();this._attemptSilentAuth()}},{key:"_loggedIn",value:function(){at_debug.log("User is logged in with Microsoft Account"),this._ms.hasValidSession()&&(this._accessToken=this._ms.token.access_token,this.isAuth=!0,this._authDone_res(),this.tools.loginDone(this.isAuth,this._isManualLogin))}},{key:"_getSheetData",value:function(e,t){return this._ms.graph.workBookSheetByDriveAndWorkbookId(this._source.driveId,this._source.workbookId,e,t).then((function(t){if(at_debug.log("We have data for sheet '"+e+"' ",t),t.hasOwnProperty("error"))throw t.error;return t})).catch((function(e){throw at_debug.log("Error on getSheet Data !",e),e}))}},{key:"_attemptSilentAuth",value:function(){var e=this,t=!1,n=function(n){t||(t=!0,clearTimeout(r),n&&console.log("Microsoft sign in error: "+n.error.message),e.tools.showManualLogin(i.u.MICROSOFT),e._isManualLogin=!0)},r=setTimeout(n,4e3);this._ms.login(!0).then((function(){clearTimeout(r)}),n)}},{key:"_buildDataTableFromArrays",value:function(e,t,n){for(var r,a,o,i={cols:e[0].map((function(e,t){return{id:(0,x.zI)(t+1),label:e,type:"string",isNumber:!0,isDate:!0,isEmpty:!0}})),parsedNumHeaders:1,rows:[]},s=2;s<e.length;s++){for(var u=e[s],c=t[s],l=n[s],h=[],f=0;f<u.length;f++)isNaN(u[f])&&(i.cols[f].isNumber=!1),""!=u[f]&&(i.cols[f].isEmpty=!1),null===(o=l[f]).match(/^#|([^\\])#/g)&&(o.indexOf(";@")>0||o.indexOf("AM/PM")>0||null!==o.match(/^y|([^\\])y/g)||null!==o.match(/^m|([^\\])m/g)||null!==o.match(/^d|([^\\])d/g)||null!==o.match(/^h|([^\\])h/g)||null!==o.match(/^s|([^\\])s/g)||null!==o.match(/\[\$-(.*?)]/g))?u[f]=(r=u[f],a=void 0,isNaN(r)?null:(a=r<61?new Date(1e3*Math.round(86400*(r-25568))):new Date(1e3*Math.round(86400*(r-25569))),"Date(".concat(a.getUTCFullYear(),",").concat(a.getUTCMonth(),",").concat(a.getUTCDate(),",").concat(a.getUTCHours(),",").concat(a.getUTCMinutes(),",").concat(a.getUTCSeconds(),",").concat(a.getUTCMilliseconds(),")"))):i.cols[f].isDate=!1,h.push({v:u[f],f:c[f]});i.rows.push({c:h})}for(var d=0;d<e[0].length;d++)i.cols[d].isEmpty?i.cols[d].type="string":i.cols[d].isDate?i.cols[d].type="datetime":i.cols[d].isNumber&&(i.cols[d].type="number");return i}},{key:"_buildTemplateTableFromArrays",value:function(t,n){if(e.isTemplateNotExists(t))return e.templateDefault;var r,a=ne(n);return(r=1===t.length?{templates:[{label:X.YM,template:""+t[0][0]}],noAutoAdd:!1}:3===t.length?{templates:t[0].map((function(e,n){if(t[2][n])return{label:(""+e||X.rd).trim(),template:""+(t[2][n]||"")}})),noAutoAdd:!1}:{templates:t[0].map((function(e,n){return{label:(""+e||X.rd).trim(),template:""+(t[1][n]||"")}})),noAutoAdd:3!==a.height}).signature=Y.Z.SHA256(JSON.stringify(r)).toString(),r}},{key:"_getColumnsSettings",value:function(e,t){var n={};return e[0].map((function(t,r){n[t]=ue(e[1][r])})),3===t.length&&t[0].map((function(e,r){n[e]=ue(t[1][r])})),n}},{key:"_getViewDataTemplate",value:function(e,t,n){var r=this._buildDataTableFromArrays(e.values,e.text,e.numberFormat),a=this._getColumnsSettings(e.values,t),o=this._buildTemplateTableFromArrays(t,n);return new K.n({data:{dataTable:r,signature:r&&Y.Z.SHA256(JSON.stringify(r)).toString()},settings:{columns:a,signature:Y.Z.SHA256(JSON.stringify(a)).toString()},template:o})}},{key:"set",value:function(e){var t=!this._source;e.token&&(this._accessToken=e.token),this._source=new ve.i(e.sourceSettings),t&&this._auth()}},{key:"getUsedRangeForWorkSheet",value:function(e){var t=this;return function(n,r){if(!r)return t._ms.graph.workBookSheetByDriveAndWorkbookId(e.driveId,e.workbookId,n,void 0,"address").then((function(e){return e.address.split("!")[1]}));if(function(e){return!!ye.$c.exec(e.split(":")[1])}(r))return r;var a=r;return t._ms.graph.workBookSheetByDriveAndWorkbookId(e.driveId,e.workbookId,n,void 0,"address").then((function(e){var t=e.address.split("!")[1].split(":");return 2!==t.length?null:a+function(e){if(!e)return null;var t=ye.$c.exec(e);return t?t[0]:null}(t[1])}))}}},{key:"getData",value:function(){var e=this,t=this._source,n=t.dataRange,r=t.dataSheet,a=t.templateRange,o=t.templateSheet,i=t.driveId,s=t.workbookId,u=this.getUsedRangeForWorkSheet({driveId:i,workbookId:s});return this._ready.then((function(){return Promise.all([u(r,n),(o||a)&&u(o,a)])})).then((function(t){var n=be(t,2),a=n[0],i=n[1];at_debug.log("fetch ms data");var s=[e._getSheetData(r||"Data",a||void 0),i];return o&&s.push(e._getSheetData(o||"Template",i||void 0)),Promise.all(s)})).then((function(t){var n=be(t,3),r=n[0],a=n[1],o=n[2],i=o&&o.values?o.values:[];return e._getViewDataTemplate(r,i,a)})).catch((function(t){throw at_debug.error("Error thrown in getData() with error : ",t),at_debug.error("Removing session cache"),t||e._ms.logout(),t}))}},{key:"getCacheKey",value:function(){return this.buildCacheKey(this._source)}},{key:"buildCacheKey",value:function(e){return JSON.stringify(e)}},{key:"onManualLogin",value:function(){var e={};this._promptMode&&(e.prompt=this._promptMode),this._ms.login(!1,e).then(function(){at_debug.log("[onManualLogin]","Successfully logged into microsoft"),this._promptMode=null}.bind(this),(function(e){at_debug.error("[onManualLogin]","Microsoft sign in error: "+e.error.message)}))}}])&&Ee(t.prototype,n),r&&Ee(t,r),e}();function Se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Oe(e,t,n){return t&&Se(e.prototype,t),n&&Se(e,n),e}var De={},Re=0,Ie={};window.__JsonpRequest_cb__=De;var we=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.timeOut=n||e.TIMEOUT,this.resolve=null,this.reject=null,this.requestId=e.requestCount++,Ie["_".concat(this.requestId)]=this,this.node=document.createElement("script"),this.callBackName="getResponse".concat(this.requestId,"_"),De[this.callBackName]=e._callBackFunc.bind(this),this.query=t.replace("{{callBack}}","__JsonpRequest_cb__.".concat(this.callBackName)),/{{requestId}}/.test(t)&&(this.query=this.query.replace("{{requestId}}",this.requestId))}return Oe(e,null,[{key:"requestCount",get:function(){return Re},set:function(e){Re=e}},{key:"callBack",get:function(){return De}},{key:"TIMEOUT",get:function(){return 6e4}}]),Oe(e,[{key:"_queryCleanUp",value:function(e){var t=this;console.timeEnd("TIME query fetch, id:".concat(this.requestId)),this.node&&(document.head.removeChild(this.node),delete this.node),e?De[this.callBackName]=function(){t._queryCleanUp()}:delete De[this.callBackName],delete Ie["_"+this.requestId]}},{key:"send",value:function(){var e=this;console.log("SEND query: "+this.requestId);var t=new Promise((function(t,n){e.resolve=t,e.reject=n,setTimeout(n.bind(null,w.ZP.REQUEST_TIMEOUT),e.timeOut)}));return this.node.onerror=this.reject,console.time("TIME query fetch, id:".concat(this.requestId)),this.node.src=this.query,document.head.appendChild(this.node),t.then(function(){return this._queryCleanUp(),1==arguments.length?arguments[0]:arguments}.bind(this)).catch((function(t){throw e._queryCleanUp(!0),t}))}}],[{key:"errorHandler",value:function(e){var t,n=e.filename||"",r=/__JsonpRequest_cb__\.getResponse(\d+)_/.exec(n);if(r)t=Ie["_".concat(r[1])];else{if("Script error."!=e.message||""!=e.filename)return;var a=Object.keys(Ie);if(!(t=Ie[a[a.length-1]]))return}t.reject()}},{key:"_callBackFunc",value:function(){this.resolve.apply(null,1==arguments.length?arguments:[arguments])}}]),e}();window.addEventListener("error",we.errorHandler);var ke=we,Ce=n(43300);function Ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=V.tW.PROXY,this._source=void 0}var t,n,r;return t=e,(n=[{key:"set",value:function(e){this._source=new Ce.l(e.sourceSettings)}},{key:"getData",value:function(){var e=this;return new ke("".concat(this._source.proxyUrl,"&callback={{callBack}}"),9e4).send().then((function(t){if("error"===t.status&&"not_modified"===t.reason)throw w.ZP.NOT_MODIFIED;return ce({data:t.dataTable,sig:t.sig},{data:t.template,sig:t.sigTemplate},e._source.templateRange)}))}},{key:"getCacheKey",value:function(){return this.buildCacheKey(this._source)}},{key:"buildCacheKey",value:function(e){return"".concat(e.proxyUrl||e.proxy,"&").concat(e.spsUrl,"headers=2&range=").concat(e.dataRange||"","&sheet=").concat(e.dataSheet||"")+(e.query?"__"+e.query:"")+(e.templateSheet&&e.templateRange?"__templateSheet=".concat(e.templateSheet,"&templateRange=").concat(e.templateRange):"")}}])&&Ne(t.prototype,n),r&&Ne(t,r),e}(),Ue=n(7185),Le=n.n(Ue),Me=n(34831);function je(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function xe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?je(Object(n),!0).forEach((function(t){He(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):je(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function He(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Fe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Be(e,t,n){return t&&Fe(e.prototype,t),n&&Fe(e,n),e}var qe=0,Ge=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.timeOut=n||e.TIMEOUT,this.requestId=e.requestCount++,this.callBackName="".concat(e.callbackPrefix).concat(this.requestId),this.query=t.replace("{{callBack}}",this.callBackName),/{{requestId}}/.test(t)&&(this.query=this.query.replace("{{requestId}}",this.requestId))}return Be(e,null,[{key:"callbackPrefix",get:function(){return"__JsonpFetchRequest_cb__.getResponse"}},{key:"requestCount",get:function(){return qe},set:function(e){qe=e}},{key:"TIMEOUT",get:function(){return 6e4}}]),Be(e,[{key:"send",value:function(){return this._fetchWithTimeout(this.query,this.timeOut).then((function(e){if(200!==e.status)throw 429===e.status?w.ZP.RESOURCE_EXHAUSTED:e.statusText||e.status;return e.text()})).then(this._parseResponse.bind(this)).catch((function(e){var t=[];return"AbortError"===e.name||e.message&&"Request timed out"===e.message?t.push({message:w.ZP.REQUEST_TIMEOUT}):t.push({message:e}),{errors:t}}))}},{key:"_parseResponse",value:function(e){if(e.indexOf(this.callBackName)<0)throw"Not a Google Visualization JSONP";var t=e.substring(this._jsonpPosition(e)).slice(0,-2);try{return JSON.parse(t)}catch(e){throw"Unable to parse JSONP response"}}},{key:"_jsonpPosition",value:function(e){return e.indexOf(this.callBackName)+this.callBackName.length+1}},{key:"_fetchWithTimeout",value:function(e,t,n){if("undefined"==typeof AbortController)return new Promise((function(r,a){var o=setTimeout((function(){return a(new Error("Request timed out"))}),t);fetch(e,n).then((function(e){return r(e)}),(function(e){return a(e)})).finally((function(){return clearTimeout(o)}))}));var r=new AbortController,a=r.signal;return setTimeout((function(){return r.abort()}),t),fetch(e,xe(xe({},n),{},{signal:a}))}}]),e}(),Ve=n(39940);function Ye(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ke(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ye(Object(n),!0).forEach((function(t){We(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ye(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function We(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ze(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Je(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Je(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Je(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ze(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=V.tW.SPREADSHEET,this.tools=t,this._useCache=!0,this._accessToken="",this.isAuth=void 0,this._testReq={},this._isPublicSpreadsheet=void 0,this._source=void 0,window.yzxqswi=!0,window.alert=function(){}}var t,n,r;return t=e,r=[{key:"_checkTemporaryQuotaError",value:function(e){return"string"==typeof e&&e in this.ERROR_QUOTA_LIMIT}},{key:"_checkFatalError",value:function(e){return"string"==typeof e&&e in this.ERROR_FATAL}},{key:"_generateUUID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}],(n=[{key:"_doSafariAuth",value:function(){var e=this;this.googleAuthHelper||(this.googleAuthHelper=new j.N),at_debug.log("Handling safari auth"),this.ready=new Promise((function(t,n){e._authDone_res=t,e._authDone_rej=n})),this._probeSheetAccess().then((function(){e._authDone_res()})).catch((function(){e.ready.then((function(){if(e._accessToken)return e.tools.getUserEmail(e._accessToken)}));var t=e.googleAuthHelper.hasValidSession();return new Promise((function(n,r){t?(at_debug.log("trying to fetch spreadsheed with stored session token"),e._accessToken=t.access_token,n(e._probeSheetAccess.bind(e))):r()})).then((function(){e._authDone_res()})).catch((function(){e._accessToken="",e.tools.showManualLogin()}))}))}},{key:"_auth",value:function(){var t=this;if(at_debug.log("FETCH_DATA","start AUTH"),this.ready=new Promise((function(e,n){t._authDone_res=e,t._authDone_rej=n})),this._accessToken)return console.log("Login with token provided"),this.isAuth=!0,void this._probeSheetAccess().then((function(e){return t._getData_success(e)})).catch((function(n){at_debug.log("ERROR in _auth",n),t._accessToken="",t.isAuth=!1,e._checkFatalError(n)?t._authDone_rej(n):(console.log("going to step 6 (login with hint/getData failure)"),t._probeSheetAccess().then((function(e){return t._getData_success(e)})).catch((function(n){at_debug.log("ERROR in _auth step 2",n),e._checkFatalError(n)?t._authDone_rej(n):t._isPublicSpreadsheet?t.tools.showError(t._isPublicSpreadsheet,n):t.tools.showManualLogin()})))}));if(this._source.domain&&this.tools.storageAccess){this.ready.then((function(){return t.tools.getUserEmail(t._accessToken)})).then((function(e){var t=localStorage.getItem("hints");t=(t&&-1===t.indexOf(e)?t+",":"")+e,localStorage.setItem("hints",t)})).catch((function(){})),at_debug.log("FETCH_DATA","login with domain");for(var n,r=localStorage.hints&&localStorage.hints.split(",")||[],a=0;a<r.length;a++)if(-1!==r[a].indexOf(this._source.domain)){n=r[a];break}n?(at_debug.log("FETCH_DATA","login with hint: ".concat(n)),this.tools.login({login_hint:n}).then((function(e){return t._accessToken=e&&e.access_token||"",t.isAuth=!0,t._probeSheetAccess()})).then((function(e){return t._getData_success(e)})).catch((function(n){at_debug.log("ERROR in _auth (email)",n),e._checkFatalError(n)?t._authDone_rej(n):(at_debug.error("FETCH_DATA","login with hint failed, retry with no auth"),t._accessToken="",t.isAuth=!1,t._probeSheetAccess().then((function(e){return t._getData_success(e)})).catch((function(n){at_debug.log("ERROR in _auth (email) step 2 ",n),e._checkFatalError(n)?t._authDone_rej(n):t._isPublicSpreadsheet?t.tools.showError(t._isPublicSpreadsheet,n):t.tools.showManualLogin()})))}))):this._loginAuthUser(0)}else this.ready.then((function(){return t.tools.getUserEmail(t._accessToken)})).catch((function(){})),at_debug.log("FETCH_DATA","try public load"),this._probeSheetAccess().then((function(e){return t._getData_success(e)})).catch((function(n){at_debug.log("ERROR in _auth (no domain) ",n),e._checkFatalError(n)?t._authDone_rej(n):(at_debug.log("FETCH_DATA","public load FAIL: data is not accessible"),e._checkTemporaryQuotaError(n)?t.tools.showError(t._isPublicSpreadsheet,n):t._loginAuthUser(0))}))}},{key:"_getSheetData",value:function(e){var t=this,n=e.sheet,r=e.headerRows,a=e.range,o=e.query,i=e.sig,s=e.forceUpdate;o="string"==typeof o?o:"";var u="".concat(this._source.spsUrl,"headers=").concat(r||0,"&range=").concat(encodeURIComponent(a)||"","&sheet=").concat(encodeURIComponent(n)||""),c=u+o;if(this._testReq[c]){if(!s)return Promise.resolve({data:this._testReq[c].data,sig:this._testReq[c].sig});delete this._testReq[c]}var l=u+"&quotaUser=".concat(this._quotaUser())+(this._accessToken?"&access_token=".concat(this._accessToken):"")+(o?"&tq=".concat(encodeURIComponent(o)):"")+"&tqx=reqId%3A{{requestId}}"+(i?";sig%3A".concat(i):"")+";responseHandler%3A{{callBack}}";return new Ge(l,9e4).send().then((function(e){var r=e.errors&&e.errors[0]&&e.errors[0].message;if(r)throw(0,Me.e)(new Error(JSON.stringify({message:r,name:"[GSHEET APIERROR] [_getSheetData]",additional:"Error for user ".concat(t._isPublicSpreadsheet," for query ").concat(l," on _getSheetData")}))),r;if(-1!==o.toLowerCase().indexOf("label")){var s=Ze(a.split(":"),2),u=s[0],c=s[1],h=parseInt(u.replace(/[a-zA-Z]*/g,""))+1,f=u.replace(/[0-9]*/g,"")+h+":"+(c.replace(/[0-9]*/g,"")+h),d="".concat(t._source.spsUrl,"headers=1&range=").concat(encodeURIComponent(f)||"","&sheet=").concat(encodeURIComponent(n)||"")+"&quotaUser=".concat(t._quotaUser())+(t._accessToken?"&access_token=".concat(t._accessToken):"")+"&tqx=reqId%3A{{requestId}}"+(i?";sig%3A".concat(i):"")+";responseHandler%3A{{callBack}}";return new Ge(d,9e4).send().then((function(n){if(n.errors){var r=n.errors&&n.errors[0]&&n.errors[0].message;if(r)throw(0,Me.e)(new Error(JSON.stringify({message:r,name:"[GSHEET APIERROR] [_getSheetData label]",additional:"Error for user ".concat(t._quotaUser()," for query ").concat(d," on _getSheetData")}))),r}else{var a=n.table.cols.reduce((function(e,t){return Ke(Ke({},e),{},We({},t.id,t.label))}),{});e.table.cols.forEach((function(e){-1===e.label.indexOf(a[e.id])&&(e.label="".concat(e.label," ").concat(a[e.id]))}))}return{data:e.table,sig:e.sig}}))}return{data:e.table,sig:e.sig}}))}},{key:"_getData_success",value:function(e){at_debug.log("FETCH_DATA","auth SUCCESS");var t="".concat(this._source.spsUrl,"headers=2&range=").concat(encodeURIComponent(this._source.dataRange),"&sheet=").concat(encodeURIComponent(this._source.dataSheet));this._testReq[t+this._source.query]={data:e.data,sig:e.sig},this._authDone_res()}},{key:"_loginAuthUser",value:function(t){var n=this;t>=e.AUTH_USER_MAX_TENTATIVES?this._probeSheetAccess().then((function(e){n._getData_success(e)})).catch((function(t){at_debug.log("ERROR in _loginAuthUser ",t),e._checkFatalError(t)?n._authDone_rej(t):(at_debug.log("FETCH_DATA","auth FAILED, waiting for error or manual login if no cache"),n.tools.showError(n._isPublicSpreadsheet,t),n.tools.sendAuthAnalytics("max tentative"))})):(at_debug.log("FETCH_DATA","login with user ".concat(t)),this.tools.login({authUser:t}).then((function(e){return n._accessToken=e&&e.access_token||"",n.isAuth=!0,n._probeSheetAccess()})).then((function(e){n._getData_success(e),n.tools.sendAuthAnalytics(t)})).catch((function(r){at_debug.log("ERROR in tools.login ",r),n._accessToken="",n.isAuth=!1,e._checkFatalError(r)?n._authDone_rej(r):n._isPublicSpreadsheet?n.tools.showError(n._isPublicSpreadsheet,r):n._loginAuthUser(t+1)})))}},{key:"_isSpreadsheetPublic",value:function(e){var t=this;return"boolean"==typeof this._isPublicSpreadsheet?Promise.resolve(this._isPublicSpreadsheet):fetch("https://docs.google.com/spreadsheets/d/".concat(e,"/trash/read?includes_info_params=true"),{method:"HEAD",redirect:"manual"}).then((function(e){return e.status<=200?e.headers.get("content-type")&&e.headers.get("content-type").indexOf("application/json")>=0||!1:t._source.isPublicSps||!1})).catch((function(){return t._source.isPublicSps||!1}))}},{key:"_probeSheetAccess",value:function(){var e=this;return new Promise((function(t,n){e._isSpreadsheetPublic(e._source.spsId).then((function(t){return e._isPublicSpreadsheet=t,at_debug.log("Spreadsheet is "+(t?"public":"private")),e._source.isPublicSps!==t&&e.tools.updateAccess(t),e._probeSheet(e._source.spsId)})).then((function(t){if(t.isAxiosError&&((0,Me.e)(new Error(JSON.stringify(Ke(Ke({},t.error),{},{name:"[GSHEET APIERROR] [_probeSheet]",additional:"Status ".concat(t.error.code," (").concat(t.error.status,") for spreadsheet ").concat(e._source.spsId," on probesheet for user ").concat(e._quotaUser())})))),t.error.status&&t.error.status===w.ZP.PERMISSION_DENIED))throw w.ZP.ACCESS_DENIED;return e._getSheetData({sheet:e._source.dataSheet,range:e._source.dataRange,headerRows:2,query:e._source.query,forceUpdate:!0})})).then(t).catch((function(e){at_debug.log("ERROR in _probeSheetAccess",e),n(e)}))}))}},{key:"_quotaUser",value:function(){if(this.tools.storageAccess)try{var t=localStorage.getItem("_QUSER");return t||(t=localStorage.getItem("_BEAMER_USER_ID_".concat("AZasvKVc19194","_").concat("AZasvKVc19194"))||e._generateUUID(),localStorage.setItem("_QUSER",t)),t}catch(e){at_debug.error("QUOTA","Unable to access local storage")}return e._generateUUID()}},{key:"_probeSheet",value:function(e){var t=this._quotaUser(),n="https://sheets.googleapis.com/v4/spreadsheets/".concat(e,"?fields=spreadsheetId&quotaUser=").concat(t,"&key=").concat("AIzaSyBDId7dThnefJgka1uaGBdxSe-cjoCZyL0");return Le().get(n,{headers:{Authorization:"Bearer ".concat(this._accessToken)}})}},{key:"set",value:function(e){var t=!this._source;this._forceUpdate=e.forceUpdate,this._useCache=e.useCache,e.token&&(this._accessToken=e.token),this._source=new Ve.L(e.sourceSettings),"safari"===a().getParser(window.navigator.userAgent).getBrowserName(!0)?t&&this._doSafariAuth():t&&this._auth()}},{key:"getData",value:function(){var t=this;return this.ready.then((function(){return Promise.all([t._getSheetData({sheet:t._source.dataSheet,range:t._source.dataRange,headerRows:2,query:t._source.query,forceUpdate:t._forceUpdate}),t._source.hasTemplate&&t._getSheetData({sheet:t._source.templateSheet,range:t._source.templateRange,headerRows:0,forceUpdate:t._forceUpdate})])})).then((function(n){var r=Ze(n,2),a=r[0],o=r[1];if(!a.data)throw e.ERRORS.NO_DATA_IN_RESPONSE;return ce(a,o,t._source.templateRange)})).catch((function(e){if(!t._forceUpdate)throw e;return t._forceUpdate=!1,t._auth(),t.getData()})).catch((function(e){throw"string"!=typeof e&&(e=w.ZP.LOADING_ERROR),at_debug.error("FETCH_DATA",e),e}))}},{key:"getCacheKey",value:function(){return this.buildCacheKey(this._source)}},{key:"buildCacheKey",value:function(e){return"".concat(e.spsUrl,"headers=2&range=").concat(e.dataRange||"","&sheet=").concat(e.dataSheet||"")+(e.query?"__"+e.query:"")+(e.templateSheet&&e.templateRange?"__templateSheet=".concat(e.templateSheet,"&templateRange=").concat(e.templateRange):"")}},{key:"onManualLogin",value:function(){var e=this;this.tools.login({authUser:-1,immediate:!1}).then((function(t){e._accessToken=t&&t.access_token||"",e.isAuth=!0,e.tools.loginDone(e.isAuth),e._authDone_res()})).catch((function(t){t.error&&"popup_closed_by_user"===t.error||(e._accessToken="",e.isAuth=!1,e.tools.loginDone(e.isAuth),e._authDone_rej())}))}}])&&ze(t.prototype,n),r&&ze(t,r),e}();Qe.AUTH_USER_MAX_TENTATIVES=6,Qe.ERROR_AUTH=w.Wv,Qe.ERROR_FATAL=w.tp,Qe.ERROR_QUOTA_LIMIT=w.NL,Qe.ERRORS={NO_DATA_IN_RESPONSE:"Error: no Data in response"};var Xe,$e={spreadsheet:Qe,proxy:Pe,aodocs:ge,ms_excel:Te};function et(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function tt(e){return(tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function nt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var rt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.logger=new N,this._ref=window.name,this._queryLogin=new G(this.logger),this._viewId=null,this._sendDataCallBack=null,this.source=void 0,this._listener=this._listener.bind(this),this._onManualLogin=this._onManualLogin.bind(this),this._observe_persistedData=this._observe_persistedData.bind(this),this._cache=new D("awesome-table-db","awesome-table-store",this._observe_persistedData),this._hasLoadedFromCache=!1,window.addEventListener("message",this._listener,!1),document.getElementById("loginBtn").addEventListener("click",this._onManualLogin,!1),this.sendMessage({loaded:!0})}var t,n,r;return t=e,(n=[{key:"_listener",value:function(e){var t=this,n=new URL("https://view-awesome-table.com");if(e.origin===n.origin&&"object"===tt(e.data)&&"ref"in e.data&&e.data.ref===this._ref&&e.data._id&&e.data.msg&&at[e.data.msg]){var r=function(n){void 0!==n&&t.sendMessage({_id:e.data._id,_res:n})},a=function(){t.sendMessage({_id:e.data._id,_fail:!0})};Promise.resolve().then((function(){return t[at[e.data.msg]](e.data.data,r,a)})).then(r).catch(a)}}},{key:"sendMessage",value:function(e){e.ref=this._ref,window.parent.postMessage(e,"*")}},{key:"setAuthProvider",value:function(e){document.body.className=e}},{key:"hasNoEmail",value:function(e){var t=this;return Promise.resolve().then((function(){return t._queryLogin.ref.child("views/".concat(e,"/hasEmail")).once("value")})).then((function(){return!1})).catch((function(e){return"PERMISSION_DENIED"===e.code}))}},{key:"getData",value:function(e,t){var n=this;this._sendDataCallBack=t,e.viewId&&(this._viewId=e.viewId),e.initialReferrer&&this.logger.setReferer(e.initialReferrer),this.logger.setInfo({provider:e.sourceSettings.source,appId:this._viewId,referrer:I.Z.referrer,appTier:e.appTier,vizType:e.vizType,allowMapsOverusage:e.allowMapsOverusage});var r=a().getParser(window.navigator.userAgent),o=Boolean("safari"===r.getBrowserName(!0));return this._checkStorageAccess().then((function(r){return!e.sourceSettings.source||n.source&&n.source.name===e.sourceSettings.source||(n.source=new $e[e.sourceSettings.source]({clearCache:n._cache.clearCacheForKey,login:n._queryLogin.googleLogin(o),getUserEmail:n._getUserEmail.bind(n),loginDone:n._loginDone.bind(n),showManualLogin:n._showManualLogin.bind(n),sendAuthAnalytics:n._sendAuthAnalytics.bind(n),showError:n._showError.bind(n),updateAccess:n._updateSpreadsheetPublic.bind(n),storageAccess:r})),e.useCache&&n._cache.setKey(n.source.buildCacheKey(e.sourceSettings)),n.source.set(e),n.source.getData().then((function(t){e.useCache?n._cache.setData(t):n._sendData(t,!1,!1)})).catch((function(r){r!==w.ZP.NOT_MODIFIED&&(n.source.ERROR_FATAL&&!(r in n.source.ERROR_FATAL)&&(r=w.ZP.LOADING_ERROR),at_debug.error("FETCH_DATA",r),t({error:r,useCache:e.useCache,dataFromCache:!1}))}))}))}},{key:"_checkStorageAccess",value:function(){return Promise.resolve().then((function(){if(document.hasStorageAccess)return document.hasStorageAccess().then((function(e){return document.requestStorageAccess().then((function(){return!0})).catch((function(){return at_debug.log("Storage access not accessible"),!1}))}));try{if(void 0===window.localStorage)return!1}catch(e){return!1}return!0}))}},{key:"_sendData",value:function(e,t,n){this._sendDataCallBack&&this._sendDataCallBack({content:e,useCache:t,dataFromCache:n}),this.logger.setDataFetched()}},{key:"_observe_persistedData",value:function(e,t){t&&JSON.stringify(e)===JSON.stringify(t)||(this._hasLoadedFromCache=void 0===t,this._hasLoadedFromCache?at_debug.log("QUERY_FRAME","Have data from cache, sending the data and load to view"):at_debug.log("QUERY_FRAME","Have fresh data, sending the data update the view"),this._sendData(e,!0,void 0===t))}},{key:"_getUserEmail",value:function(e){return this._queryLogin.login(e).then((function(e){return e&&e.providerData&&e.providerData[0].email||null}))}},{key:"_onManualLogin",value:function(){console.log("MANUAL login"),this.source.onManualLogin&&this.source.onManualLogin()}},{key:"_loginDone",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.sendMessage({manualLogin:t,isAuth:e})}},{key:"_updateSpreadsheetPublic",value:function(e){if(this._viewId){at_debug.log("Setting spreadsheet as public = ".concat(e," for view ").concat(this._viewId));try{(0,o.Q8)("views/".concat(this._viewId,"/settings/source"),{isPublicSps:e})}catch(e){}}}},{key:"_showError",value:function(e,t){var n=t&&(t===w.ZP.REQUEST_TIMEOUT||t===w.ZP.RESOURCE_EXHAUSTED);e&&this._hasLoadedFromCache?at_debug.log("QueryFrame","Keeping cache displayed"):e?this.sendMessage({showError:!0,reason:t,isAPILimitation:n}):this._showManualLogin()}},{key:"_showManualLogin",value:function(e){this._hasLoadedFromCache&&this.source&&this._cache.clearCacheForKey(this.source.getCacheKey()),this.sendMessage({showLogin:!0,authSource:e||i.u.GOOGLE})}},{key:"_sendAuthAnalytics",value:function(e){this._authAnalytics||(this._authAnalytics=new R.Z("UA-17877121-7","awtDomain"),this._authAnalytics.setCustomD({dimension4:"4.98.0"})),this._authAnalytics.sendStats({hitType:"event",eventCategory:"latestAuth",eventAction:e,eventLabel:"awesome-table"})}}])&&nt(t.prototype,n),r&&nt(t,r),e}(),at=(et(Xe={},P.a.HAS_NO_EMAIL,"hasNoEmail"),et(Xe,P.a.GET_DATA,"getData"),et(Xe,P.a.SET_AUTH_PROVIDER,"setAuthProvider"),Xe),ot=rt,it=/(?:^\?|&)debug(?:&|$)/.test(document.location.search);window.at_debug=it?window.console:{log:function(){},error:function(){}},new ot},48668:function(e,t,n){n.d(t,{Wv:function(){return a},tp:function(){return o},NL:function(){return i}});var r={REQUEST_TIMEOUT:"REQUEST_TIMEOUT",ACCESS_DENIED:"ACCESS_DENIED",LOADING_ERROR:"LOADING_ERROR",INVALID_QUERY:"INVALID_QUERY",INVALID_RANGE:"INVALID_RANGE",PERMISSION_DENIED:"PERMISSION_DENIED",NOT_MODIFIED:"NOT_MODIFIED",RESOURCE_EXHAUSTED:"RESOURCE_EXHAUSTED",VIEW_CANT_LOAD:"VIEW_CANT_LOAD"},a={ACCESS_DENIED:r.ACCESS_DENIED,LOADING_ERROR:r.LOADING_ERROR},o={INVALID_RANGE:r.INVALID_RANGE,INVALID_QUERY:r.INVALID_QUERY,REQUEST_TIMEOUT:r.REQUEST_TIMEOUT},i={RESOURCE_EXHAUSTED:r.RESOURCE_EXHAUSTED,REQUEST_TIMEOUT:r.REQUEST_TIMEOUT};t.ZP=r},62:function(e,t,n){n.d(t,{a:function(){return r}});var r={HAS_NO_EMAIL:"noEmail?",GET_DATA:"getData?",SET_AUTH_PROVIDER:"setAuthProvider?"}},10139:function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n.d(t,{n:function(){return a}});var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t=t||{},this.data={},this.data.dataTable=t.data&&t.data.dataTable||null,this.data.signature=t.data&&t.data.signature||null,this.settings={columns:t.settings&&t.settings.columns||{},signature:t.settings&&t.settings.signature||""},this.template={templates:t.template&&t.template.templates||[],signature:t.template&&t.template.signature||null,onlyDisplay:t.template&&t.template.onlyDisplay||null,noAutoAdd:!t.template||void 0===t.template.noAutoAdd||t.template.noAutoAdd}}var t,n,a;return t=e,(n=[{key:"hasData",get:function(){return this.data&&!!this.data.dataTable}},{key:"hasTemplate",get:function(){return this.template&&this.template.templates&&!!this.template.templates.length}}])&&r(t.prototype,n),a&&r(t,a),e}()},50473:function(e,t,n){n.d(t,{u:function(){return r},k:function(){return a}});var r={GOOGLE:"google",MICROSOFT:"microsoft"},a=2592e6},7749:function(e,t,n){n.d(t,{BI:function(){return r},xG:function(){return a},rd:function(){return o},YM:function(){return i},fP:function(){return s},c0:function(){return u}});var r="<style>",a="<script>",o="<global_html>",i="<simple_template></simple_template>",s="GeoChartOptions",u=/chartOptions\((.*)\)/},43650:function(e,t,n){n.r(t),n.d(t,{CARDS_COLOR:function(){return r},CARDS_CONTENT:function(){return a},MAPS_LAT:function(){return o},MAPS_LONG:function(){return i},MAPS_TOOLTIP:function(){return s},MAPS_MARKER:function(){return u},TOOLTIP:function(){return c},LATITUDE:function(){return l},LONGITUDE:function(){return h},GEOCHART_LOCATION:function(){return f},GEOCHART_COLORS:function(){return d},GEOCHART_MARKERS_SIZE:function(){return _},GEOCHART_VALUE:function(){return p},SLIDE_IMAGE:function(){return g},SLIDE_LINK:function(){return m},SLIDE_TITLE:function(){return y},SLIDE_TEXT:function(){return v},SLIDE_CONTENT:function(){return b},BI_COUNT:function(){return A},BI_TOP_RESULTS:function(){return E},BI_WORD_CLOUD:function(){return T},BI_COLUMN_CHART:function(){return S},BI_AGGREGATE:function(){return O},BI_BAR_CHART:function(){return D},BI_LINE_CHART:function(){return R},BI_AREA_CHART:function(){return I},BI_HISTOGRAM:function(){return w},BI_CANDLESTICK_CHART:function(){return k},BI_PIE:function(){return C},PIE_CHART:function(){return N},DONUT_CHART:function(){return P},DIMENSION_PIE_CHART:function(){return U},DIMENSION_DONUT_CHART:function(){return L},LINE_CHART:function(){return M},SMOOTH_LINE_CHART:function(){return j},COMBO_CHART:function(){return x},BUBBLE_CHART:function(){return H},COLUMN_CHART:function(){return F},STACKED_COLUMN_CHART:function(){return B},PERCENT_STACKED_COLUMN_CHART:function(){return q},BAR_CHART:function(){return G},STACKED_BAR_CHART:function(){return V},PERCENT_STACKED_BAR_CHART:function(){return Y},AREA_CHART:function(){return K},STACKED_AREA_CHART:function(){return W},STEPPED_AREA_CHART:function(){return Z},STACKED_STEPPED_AREA_CHART:function(){return J},PERCENT_STACKED_AREA_CHART:function(){return z},PERCENT_STACKED_STEPPED_AREA_CHART:function(){return Q},SCATTER_CHART:function(){return X},GANTT_GROUP:function(){return $},GANTT_LABEL:function(){return ee},GANTT_TOOL_TIP:function(){return te},GANTT_START_DATE:function(){return ne},GANTT_END_DATE:function(){return re},COLUMN_ROLE_HIDDEN:function(){return ae},COLUMN_ROLE_SIDEBAR:function(){return oe},DATA_CSV:function(){return ie},TYPE_POPUP:function(){return se},TYPE_HYPERLINK:function(){return ue},TYPE_IMAGE:function(){return ce},TYPE_ICON:function(){return le},TYPE_RATING:function(){return he},TYPE_BUTTON:function(){return fe},TYPE_LIST:function(){return de},TYPE_NUMBEREDLIST:function(){return _e},TYPE_COLOR:function(){return pe},FILTER_NONE:function(){return ge},FILTER_NUMBERRANGE:function(){return me},FILTER_DATE:function(){return ye},FILTER_DATERANGE:function(){return ve},FILTER_STRING:function(){return be},FILTER_CATEGORY:function(){return Ae},FILTER_CSV:function(){return Ee},FILTER_CSV_OR:function(){return Te},FILTER_CSV_AND:function(){return Se},ORG_CHART_NAME:function(){return Oe},ORG_CHART_REPORTS_TO:function(){return De},ORG_CHART_CARD_CONTENT:function(){return Re}});var r="cardscolor",a="cardscontent",o="mapslat",i="mapslong",s="mapstooltip",u="mapsmarker",c="tooltip",l="latitude",h="longitude",f="geochartlocation",d="geochartcolor",_="geochartmarkersize",p="geochartvalue",g="slideimage",m="slidelink",y="slidetitle",v="slidetext",b="slidecontent",A="bicount",E="bitopresults",T="biwordcloud",S="bicolumnchart",O="biaggregate",D="bibarchart",R="bilinechart",I="biareachart",w="histogram",k="waterfallchart",C="bipie",N="piechart",P="donutchart",U="3dpiechart",L="3ddonutchart",M="linechart",j="smoothlinechart",x="combochart",H="bubblechart",F="columnchart",B="stackedcolumnchart",q="100stackedcolumnchart",G="barchart",V="stackedbarchart",Y="100stackedbarchart",K="areachart",W="stackedareachart",Z="steppedareachart",J="stackedsteppedareachart",z="100stackedareachart",Q="100stackedsteppedareachart",X="scatterchart",$="ganttgroup",ee="ganttlabel",te="gantttooltip",ne="ganttstartdate",re="ganttenddate",ae="hidden",oe="sidebar",ie="csvdata",se="popuptype",ue="hyperlinktype",ce="imagetype",le="icontype",he="ratingtype",fe="buttontype",de="listtype",_e="numberedlisttype",pe="colortype",ge="nofilter",me="numberrangefilter",ye="datefilter",ve="daterangefilter",be="stringfilter",Ae="categoryfilter",Ee={name:"csvfilter",regex:"csvfilter(?!or)(?!and)"},Te="csvfilteror",Se="csvfilterand",Oe="orgchartname",De="orgchartparent",Re="cardscontent"}},function(e){e.O(0,[5831,7597,7039,4207,9015,6892,4317,6320,8705,9175],(function(){return t=18518,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=query.70e955b5af35e98c1f8e.js.map